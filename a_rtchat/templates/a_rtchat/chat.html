{% extends 'layouts/sidebar_layout.html' %}

{% block content %} 
<script src="https://unpkg.com/htmx.org@1.9.6"></script>
<script src="https://unpkg.com/htmx.org/dist/ext/ws.js"></script>
<div class="h-full flex flex-col">
    <!-- Chat Header -->
    <div class="flex items-center bg-gradient-to-r from-gray-900 to-gray-800 p-4 sticky top-0 z-10 border-b border-gray-700 shadow-md">
        {% if other_user %}
        <div class="flex items-center">
            <div class="relative">
                <img class="w-12 h-12 rounded-full object-cover border-2 border-indigo-600 shadow-lg hover:scale-105 transition-transform" src="{{ other_user.profile.avatar }}" />
                {% if other_user in chat_group.users_online.all %}
                <div class="green-dot border-2 border-gray-900 absolute bottom-0 right-0 shadow-md animate-pulse"></div>
                {% else %}
                <div class="gray-dot border-2 border-gray-900 absolute bottom-0 right-0"></div>
                {% endif %}
            </div>
            <div class="ml-3">
                <a href="{% url 'profile' other_user.username %}" class="font-bold text-white hover:text-indigo-300 hover:underline transition-colors">{{ other_user.profile.name }}</a>
                <div class="text-sm font-light text-gray-400">@{{ other_user.username }}</div>
            </div>
        </div>
        {% elif chat_group.groupchat_name %}
        <div class="flex items-center justify-between w-full">
            <div class="flex items-center">
                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-indigo-500 to-indigo-700 flex items-center justify-center text-xl font-bold text-white shadow-lg">
                    {{ chat_group.groupchat_name|slice:":1"|upper }}
                </div>
                <div class="ml-3">
                    <h2 class="text-xl text-white font-bold">{{ chat_group.groupchat_name }}</h2>
                    <div class="text-sm text-gray-400">{{ chat_group.members.count }} members</div>
                </div>
            </div>
            {% if user == chat_group.admin %}
            <a href="{% url 'edit-chatroom' chat_group.group_name %}" class="p-2 bg-gray-700 hover:bg-indigo-600 rounded-lg transition-colors shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
            </a>
            {% endif %}
        </div>
        {% else %}
        <div class="flex items-center">
            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-indigo-500 to-indigo-700 flex items-center justify-center text-xl font-bold text-white shadow-lg">
                P
            </div>
            <div class="ml-3">
                <h2 class="text-xl text-white font-bold">Public Chat</h2>
                <div class="text-sm text-gray-400">
                    <span id="online-count" class="font-medium">0</span> users online
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Group members display for group chats -->
    {% if chat_group.groupchat_name %}
    <div class="flex overflow-x-auto py-3 px-4 bg-gradient-to-r from-gray-900 to-gray-850 border-b border-gray-700 shadow-sm">
        <ul id="groupchat-members" class="flex gap-3">
            {% for member in chat_group.members.all %}
            <li>
                <a href="{% url 'profile' member.username %}" class="flex flex-col items-center px-2 hover:bg-gray-800 rounded-lg py-1 transition-colors">
                    <div class="relative">
                        {% if member in chat_group.users_online.all %}
                        <div class="green-dot border border-gray-900 absolute -bottom-1 -right-1 scale-75 animate-pulse"></div>
                        {% else %}
                        <div class="gray-dot border border-gray-900 absolute -bottom-1 -right-1 scale-75"></div>
                        {% endif %}
                        <img src="{{ member.profile.avatar }}" class="w-9 h-9 rounded-full object-cover border border-gray-700 hover:border-indigo-500 transition-colors" />
                    </div>
                    <span class="text-xs text-gray-400 mt-1 font-medium">{{ member.profile.name|slice:":8" }}</span>
                </a>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- Chat Messages -->
    <div id='chat_container' class="flex-1 overflow-y-auto bg-gradient-to-b from-gray-900 to-gray-950 p-4 bg-opacity-95 backdrop-blur-sm">
        <ul id='chat_messages' class="flex flex-col justify-end gap-3 max-w-3xl mx-auto">
            {% for message in chat_messages reversed %}
            {% include 'a_rtchat/chat_message.html' %}
            {% endfor %}
        </ul>
    </div>

    <!-- Chat Input -->
    <div class="sticky bottom-0 z-10 p-4 bg-gradient-to-r from-gray-900 to-gray-800 border-t border-gray-700 shadow-lg">
        <div class="max-w-3xl mx-auto">
            <form id="chat_message_form" class="w-full mb-3"
                hx-ext="ws"
                ws-connect="/ws/chatroom/{{ chatroom_name }}"
                ws-send 
                _="on htmx:wsAfterSend reset() me">
                {% csrf_token %}
                <div class="flex">
                    {{ form.body }}
                    <button type="submit" class="ml-2 px-4 bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 rounded-lg text-white transition-all shadow-md hover:shadow-lg transform hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                        </svg>
                    </button>
                </div>
            </form>

            <form id="chat_file_form" enctype="multipart/form-data" class="flex items-center w-full" 
                hx-post="{% url 'chat-file-upload' chat_group.group_name %}"
                hx-target="#chat_messages"
                hx-swap="beforeend" 
                _="on htmx:beforeSend reset() me" >
                {% csrf_token %}
                <div class="flex items-center w-full">
                    <label for="id_file" class="cursor-pointer flex items-center text-gray-400 hover:text-indigo-300 transition-colors flex-1 bg-gray-800 hover:bg-gray-750 py-2 px-3 rounded-lg shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                        </svg>
                        <span>Attach file</span>
                    </label>
                    <input type="file" name="file" id="id_file" class="hidden">
                    <button type="submit" class="ml-2 py-2 px-4 bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 rounded-lg text-white transition-all shadow-md hover:shadow-lg text-sm transform hover:scale-105">
                        Upload
                    </button>
                </div>
            </form>
        </div>
    </div>

    {% if chat_group.members.exists and not chat_group.group_name == 'public-chat' %}
    <div class="p-3 bg-gradient-to-r from-gray-900 to-gray-800 border-t border-gray-700 text-center">
        {% include 'a_rtchat/partials/modal_chat_leave.html' %}
    </div>
    {% endif %}
</div>

{% endblock %}

{% block javascript %}
<script>
    function scrollToBottom(time=0) {
        setTimeout(function() {
            const container = document.getElementById('chat_container');
            container.scrollTop = container.scrollHeight;
        }, time);
    }
    scrollToBottom();

    // Show filename in file input
    document.getElementById('id_file').addEventListener('change', function(e) {
        const filename = e.target.files[0]?.name;
        if (filename) {
            const label = document.querySelector('label[for="id_file"]');
            label.querySelector('span').textContent = filename;
        }
    });
</script>
{% endblock %}
